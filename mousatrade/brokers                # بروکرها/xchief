"""
Ø¨Ø±ÙˆÚ©Ø± XChief Ø¨Ø±Ø§ÛŒ MousaTrade
"""

import pandas as pd
import ccxt
from typing import Dict, List
from datetime import datetime, timedelta
import logging
from mousatrade.brokers.base_broker import BaseBroker

logger = logging.getLogger(__name__)

class XChiefBroker(BaseBroker):
    """Ø¨Ø±ÙˆÚ©Ø± XChief"""
    
    def __init__(self, api_key: str = None, secret: str = None):
        super().__init__("XChief", api_key, secret)
        self.exchange = None
        self._initialize_exchange()
    
    def _initialize_exchange(self):
        """Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§Ú©Ø³Ú†Ù†Ø¬"""
        try:
            # XChief Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø± CCXT Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ø´ÙˆØ¯
            # Ø¨Ù†Ø§Ø¨Ø±Ø§ÛŒÙ† Ø§Ø² ÛŒÚ© Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            self.exchange = CCXTXChiefSimulator()
            self.is_authenticated = True
            
            # Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ
            self.supported_pairs = [
                'BTC/USDT', 'ETH/USDT', 'ADA/USDT', 'DOT/USDT',
                'LINK/USDT', 'LTC/USDT', 'BCH/USDT', 'XLM/USDT'
            ]
            
            logger.info("âœ… Ø¨Ø±ÙˆÚ©Ø± XChief Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²)")
            
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ XChief: {e}")
            self.is_authenticated = False
    
    def authenticate(self) -> bool:
        """Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¨Ø§ XChief"""
        try:
            if self.api_key and self.secret:
                # Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯ API KeyØŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ÙˆØ§Ù‚Ø¹ÛŒ
                self.is_authenticated = True
            else:
                # Ø­Ø§Ù„Øª Ø¯Ù…Ùˆ - Ø¨Ø¯ÙˆÙ† Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
                self.is_authenticated = True
                
            return self.is_authenticated
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª XChief: {e}")
            self.is_authenticated = False
            return False
    
    def get_historical_data(self, symbol: str, timeframe: str, 
                          days: int = 30) -> pd.DataFrame:
        """Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®ÛŒ Ø§Ø² XChief"""
        try:
            if not self.is_authenticated:
                logger.warning("Ø¨Ø±ÙˆÚ©Ø± XChief Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª")
                return pd.DataFrame()
            
            # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®ÛŒ
            df = self.exchange.fetch_ohlcv(symbol, timeframe, days)
            
            logger.info(f"ğŸ“Š Ø¯Ø±ÛŒØ§ÙØª {len(df)} Ú©Ù†Ø¯Ù„ Ø§Ø² XChief Ø¨Ø±Ø§ÛŒ {symbol}")
            return df
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®ÛŒ Ø§Ø² XChief: {e}")
            return self._generate_sample_data(symbol, days)
    
    def get_current_price(self, symbol: str) -> float:
        """Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ Ø§Ø² XChief"""
        try:
            if not self.is_authenticated:
                return 0.0
            
            # Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ
            price = self.exchange.fetch_ticker(symbol)['last']
            return float(price)
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª Ø§Ø² XChief: {e}")
            return 0.0
    
    def get_market_info(self, symbol: str) -> Dict:
        """Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²Ø§Ø± Ø§Ø² XChief"""
        try:
            if not self.is_authenticated:
                return {}
            
            # Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²Ø§Ø±
            ticker = self.exchange.fetch_ticker(symbol)
            return {
                "symbol": symbol,
                "last_price": float(ticker['last']),
                "bid": float(ticker['bid']),
                "ask": float(ticker['ask']),
                "high_24h": float(ticker['high']),
                "low_24h": float(ticker['low']),
                "volume_24h": float(ticker['baseVolume']),
                "price_change_24h": float(ticker['percentage']),
                "spread": (float(ticker['ask']) - float(ticker['bid'])) / float(ticker['last']) * 100,
                "timestamp": datetime.now().isoformat()
            }
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²Ø§Ø± Ø§Ø² XChief: {e}")
            return {}
    
    def _generate_sample_data(self, symbol: str, days: int) -> pd.DataFrame:
        """ØªÙˆÙ„ÛŒØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§"""
        import numpy as np
        
        # ØªÙˆÙ„ÛŒØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡
        end_date = datetime.now()
        start_date = end_date - timedelta(days=days)
        
        dates = pd.date_range(start=start_date, end=end_date, freq='1H')
        n = len(dates)
        
        # ØªÙˆÙ„ÛŒØ¯ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ ØªØµØ§Ø¯ÙÛŒ Ø¨Ø§ Ø±ÙˆÙ†Ø¯
        np.random.seed(42)  # Ø¨Ø±Ø§ÛŒ Ø«Ø§Ø¨Øª Ø¨ÙˆØ¯Ù† Ù†ØªØ§ÛŒØ¬
        base_price = 50000 if 'BTC' in symbol else 3000
        returns = np.random.normal(0.001, 0.02, n)  # Ø¨Ø§Ø²Ø¯Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ ~2%
        prices = base_price * (1 + returns).cumprod()
        
        # ØªÙˆÙ„ÛŒØ¯ OHLCV
        df = pd.DataFrame({
            'timestamp': dates,
            'open': prices * 0.999,
            'high': prices * 1.005,
            'low': prices * 0.995, 
            'close': prices,
            'volume': np.random.randint(1000, 10000, n)
        })
        
        logger.info(f"ğŸ“Š ØªÙˆÙ„ÛŒØ¯ {len(df)} Ú©Ù†Ø¯Ù„ Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø±Ø§ÛŒ {symbol}")
        return df

class CCXTXChiefSimulator:
    """Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² CCXT Ø¨Ø±Ø§ÛŒ XChief"""
    
    def fetch_ohlcv(self, symbol: str, timeframe: str = '1h', days: int = 30):
        """Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ OHLCV"""
        import numpy as np
        import pandas as pd
        from datetime import datetime, timedelta
        
        # ØªÙˆÙ„ÛŒØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡
        end_date = datetime.now()
        start_date = end_date - timedelta(days=days)
        
        # ØªØ¹ÛŒÛŒÙ† ÙØ±Ú©Ø§Ù†Ø³ Ø¨Ø± Ø§Ø³Ø§Ø³ timeframe
        if timeframe == '1h':
            freq = '1H'
        elif timeframe == '1d':
            freq = '1D'
        elif timeframe == '15m':
            freq = '15T'
        else:
            freq = '1H'
        
        dates = pd.date_range(start=start_date, end=end_date, freq=freq)
        n = len(dates)
        
        # ØªÙˆÙ„ÛŒØ¯ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒâ€ŒØªØ±
        np.random.seed(hash(symbol) % 1000)  # seed Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³ÛŒÙ…Ø¨Ù„
        base_price = 50000 if 'BTC' in symbol else 3000 if 'ETH' in symbol else 100
        volatility = 0.02
        
        prices = [base_price]
        for i in range(1, n):
            change = np.random.normal(0, volatility)
            new_price = prices[-1] * (1 + change)
            prices.append(new_price)
        
        prices = np.array(prices)
        
        # ØªÙˆÙ„ÛŒØ¯ OHLC
        df = pd.DataFrame({
            'timestamp': dates,
            'open': prices * (1 + np.random.normal(0, 0.001, n)),
            'high': prices * (1 + np.abs(np.random.normal(0, 0.005, n))),
            'low': prices * (1 - np.abs(np.random.normal(0, 0.005, n))),
            'close': prices,
            'volume': np.random.lognormal(8, 1, n)  # Ø­Ø¬Ù… ØªØµØ§Ø¯ÙÛŒ
        })
        
        return df
    
    def fetch_ticker(self, symbol: str):
        """Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø±ÛŒØ§ÙØª ØªÛŒÚ©Ø±"""
        import numpy as np
        
        base_price = 50000 if 'BTC' in symbol else 3000 if 'ETH' in symbol else 100
        change = np.random.normal(0, 0.01)  # ØªØºÛŒÛŒØ± 1%
        
        return {
            'symbol': symbol,
            'last': base_price * (1 + change),
            'bid': base_price * (1 + change - 0.0005),  # Ø§Ø³Ù¾Ø±Ø¯ 0.05%
            'ask': base_price * (1 + change + 0.0005),
            'high': base_price * (1 + np.abs(change) + 0.02),
            'low': base_price * (1 - np.abs(change) - 0.02),
            'baseVolume': np.random.uniform(1000000, 50000000),
            'percentage': change * 100
        }
