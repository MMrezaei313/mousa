"""
Ø¨Ø±ÙˆÚ©Ø± Binance Ø¨Ø±Ø§ÛŒ MousaTrade
"""

import pandas as pd
import ccxt
from typing import Dict, List
import logging
from mousatrade.brokers.base_broker import BaseBroker

logger = logging.getLogger(__name__)

class BinanceBroker(BaseBroker):
    """Ø¨Ø±ÙˆÚ©Ø± Binance"""
    
    def __init__(self, api_key: str = None, secret: str = None):
        super().__init__("Binance", api_key, secret)
        self.exchange = None
        self._initialize_exchange()
    
    def _initialize_exchange(self):
        """Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§Ú©Ø³Ú†Ù†Ø¬ Binance"""
        try:
            if self.api_key and self.secret:
                self.exchange = ccxt.binance({
                    'apiKey': self.api_key,
                    'secret': self.secret,
                    'sandbox': True,  # Ø­Ø§Ù„Øª ØªØ³Øª
                    'enableRateLimit': True
                })
            else:
                self.exchange = ccxt.binance({
                    'sandbox': True,
                    'enableRateLimit': True
                })
            
            self.is_authenticated = True
            self._load_supported_pairs()
            
            logger.info("âœ… Ø¨Ø±ÙˆÚ©Ø± Binance Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯")
            
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Binance: {e}")
            self.is_authenticated = False
    
    def _load_supported_pairs(self):
        """Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡"""
        try:
            markets = self.exchange.load_markets()
            self.supported_pairs = [symbol for symbol in markets.keys() 
                                  if symbol.endswith('/USDT')][:50]  # ÙÙ‚Ø· ÛµÛ° Ù…ÙˆØ±Ø¯ Ø§ÙˆÙ„
            
            logger.info(f"ğŸ“Š {len(self.supported_pairs)} Ø¬ÙØª Ø§Ø±Ø² Ø§Ø² Binance Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯")
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬ÙØªâ€ŒØ§Ø±Ø²Ù‡Ø§ÛŒ Binance: {e}")
            self.supported_pairs = ['BTC/USDT', 'ETH/USDT', 'ADA/USDT', 'DOT/USDT']
    
    def authenticate(self) -> bool:
        """Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¨Ø§ Binance"""
        try:
            # ØªØ³Øª Ø§ØªØµØ§Ù„
            if self.exchange:
                self.exchange.fetch_balance()
                self.is_authenticated = True
                return True
            return False
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Binance: {e}")
            self.is_authenticated = False
            return False
    
    def get_historical_data(self, symbol: str, timeframe: str, 
                          days: int = 30) -> pd.DataFrame:
        """Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®ÛŒ Ø§Ø² Binance"""
        try:
            if not self.is_authenticated:
                logger.warning("Ø¨Ø±ÙˆÚ©Ø± Binance Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª")
                return pd.DataFrame()
            
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ timestamp Ø¨Ø±Ø§ÛŒ days Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡
            since = self.exchange.parse8601(
                (pd.Timestamp.now() - pd.Timedelta(days=days)).isoformat()
            )
            
            # Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ OHLCV
            ohlcv = self.exchange.fetch_ohlcv(symbol, timeframe, since)
            
            # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ DataFrame
            df = pd.DataFrame(ohlcv, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
            df['timestamp'] = pd.to_datetime(df['timestamp'], unit='ms')
            
            logger.info(f"ğŸ“Š Ø¯Ø±ÛŒØ§ÙØª {len(df)} Ú©Ù†Ø¯Ù„ Ø§Ø² Binance Ø¨Ø±Ø§ÛŒ {symbol}")
            return df
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®ÛŒ Ø§Ø² Binance: {e}")
            return pd.DataFrame()
    
    def get_current_price(self, symbol: str) -> float:
        """Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ Ø§Ø² Binance"""
        try:
            if not self.is_authenticated:
                return 0.0
            
            ticker = self.exchange.fetch_ticker(symbol)
            return float(ticker['last'])
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª Ø§Ø² Binance: {e}")
            return 0.0
    
    def get_market_info(self, symbol: str) -> Dict:
        """Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²Ø§Ø± Ø§Ø² Binance"""
        try:
            if not self.is_authenticated:
                return {}
            
            ticker = self.exchange.fetch_ticker(symbol)
            return {
                "symbol": symbol,
                "last_price": float(ticker['last']),
                "bid": float(ticker['bid']),
                "ask": float(ticker['ask']),
                "high_24h": float(ticker['high']),
                "low_24h": float(ticker['low']),
                "volume_24h": float(ticker['baseVolume']),
                "price_change_24h": float(ticker['percentage']),
                "spread": (float(ticker['ask']) - float(ticker['bid'])) / float(ticker['last']) * 100,
                "timestamp": pd.Timestamp.now().isoformat()
            }
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²Ø§Ø± Ø§Ø² Binance: {e}")
            return {}
