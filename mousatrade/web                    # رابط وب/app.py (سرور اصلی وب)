"""
Ø³Ø±ÙˆØ± ÙˆØ¨ MousaTrade
Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ ØªØ­Øª ÙˆØ¨ Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§ÙˆØ± ØªØ±ÛŒØ¯
"""

from flask import Flask, render_template, request, jsonify, session, send_from_directory
from flask_cors import CORS
import os
import json
from datetime import datetime
import logging

from mousatrade.main import mousatrade_advisor

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Flask
app = Flask(__name__, 
           template_folder='templates',
           static_folder='static')
app.secret_key = 'mousatrade-secret-key-2024'
app.config['SESSION_TYPE'] = 'filesystem'

# ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† CORS
CORS(app)

# Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§ØªÛŒÚ©
@app.route('/static/<path:filename>')
def serve_static(filename):
    return send_from_directory('static', filename)

# ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
@app.route('/')
def index():
    """ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡"""
    return render_template('index.html', 
                         app_name="MousaTrade Advisor",
                         version="1.0.0")

# API ØªÙ†Ø¸ÛŒÙ… Ø¨Ø±ÙˆÚ©Ø±
@app.route('/api/brokers', methods=['GET'])
def get_brokers():
    """Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¨Ø±ÙˆÚ©Ø±Ù‡Ø§ÛŒ available"""
    try:
        brokers = [
            {
                "id": "xchief",
                "name": "XChief",
                "supported": True,
                "auth_required": False,
                "description": "Ø¨Ø±ÙˆÚ©Ø± XChief Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ø¨Ø§Ø²Ø§Ø± Ø§ÛŒØ±Ø§Ù†"
            },
            {
                "id": "binance",
                "name": "Binance", 
                "supported": True,
                "auth_required": False,
                "description": "Ø¨Ø²Ø±Ú¯ØªØ±ÛŒÙ† ØµØ±Ø§ÙÛŒ Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„ Ø¬Ù‡Ø§Ù†"
            },
            {
                "id": "bybit",
                "name": "Bybit",
                "supported": True, 
                "auth_required": False,
                "description": "ØµØ±Ø§ÙÛŒ ØªØ®ØµØµÛŒ ÙÛŒÙˆÚ†Ø±Ø² Ùˆ Ù…Ø§Ø±Ø¬ÛŒÙ†"
            },
            {
                "id": "okx", 
                "name": "OKX",
                "supported": True,
                "auth_required": False,
                "description": "ØµØ±Ø§ÙÛŒ Ø¬Ù‡Ø§Ù†ÛŒ Ø¨Ø§ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…ØªÙ†ÙˆØ¹"
            }
        ]
        return jsonify({"brokers": brokers})
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¨Ø±ÙˆÚ©Ø±Ù‡Ø§: {e}")
        return jsonify({"error": "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø±ÙˆÚ©Ø±Ù‡Ø§"}), 500

@app.route('/api/brokers/<broker_id>', methods=['POST'])
def set_broker(broker_id):
    """ØªÙ†Ø¸ÛŒÙ… Ø¨Ø±ÙˆÚ©Ø± ÙØ¹Ø§Ù„"""
    try:
        data = request.get_json()
        
        success = mousatrade_advisor.set_broker(broker_id)
        
        if success:
            session['current_broker'] = broker_id
            return jsonify({
                "status": "success",
                "message": f"Ø¨Ø±ÙˆÚ©Ø± {broker_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯",
                "broker": broker_id
            })
        else:
            return jsonify({
                "status": "error", 
                "message": f"Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… Ø¨Ø±ÙˆÚ©Ø± {broker_id}"
            }), 400
            
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… Ø¨Ø±ÙˆÚ©Ø±: {e}")
        return jsonify({"error": str(e)}), 500

# API ØªØ­Ù„ÛŒÙ„ Ù†Ù…Ø§Ø¯
@app.route('/api/analyze/<symbol>', methods=['GET'])
def analyze_symbol(symbol):
    """ØªØ­Ù„ÛŒÙ„ Ú©Ø§Ù…Ù„ ÛŒÚ© Ù†Ù…Ø§Ø¯"""
    try:
        timeframe = request.args.get('timeframe', '1h')
        
        # Ø¨Ø±Ø±Ø³ÛŒ ØªÙ†Ø¸ÛŒÙ… Ø¨ÙˆØ¯Ù† Ø¨Ø±ÙˆÚ©Ø±
        if not mousatrade_advisor.current_broker:
            return jsonify({
                "error": "Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¨Ø±ÙˆÚ©Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯"
            }), 400
        
        # Ø§Ø¬Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„
        analysis = mousatrade_advisor.get_comprehensive_analysis(symbol, timeframe)
        
        if "error" in analysis:
            return jsonify(analysis), 400
        
        return jsonify(analysis)
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„ Ù†Ù…Ø§Ø¯ {symbol}: {e}")
        return jsonify({
            "error": f"Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„: {str(e)}"
        }), 500

# API Ø¨Ú©â€ŒØªØ³Øª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ
@app.route('/api/backtest/<symbol>', methods=['GET'])
def backtest_symbol(symbol):
    """Ø¨Ú©â€ŒØªØ³Øª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø±ÙˆÛŒ Ù†Ù…Ø§Ø¯"""
    try:
        strategy = request.args.get('strategy', 'default')
        timeframe = request.args.get('timeframe', '1h')
        days = int(request.args.get('days', '90'))
        
        if not mousatrade_advisor.current_broker:
            return jsonify({"error": "Ø¨Ø±ÙˆÚ©Ø± ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡"}), 400
        
        result = mousatrade_advisor.backtest_strategy(symbol, strategy, timeframe, days)
        
        return jsonify(result)
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ú©â€ŒØªØ³Øª {symbol}: {e}")
        return jsonify({"error": str(e)}), 500

# API Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù„ÛŒ Ø¨Ø§Ø²Ø§Ø±
@app.route('/api/market/overview', methods=['GET'])
def market_overview():
    """Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù„ÛŒ Ø¨Ø§Ø²Ø§Ø±"""
    try:
        symbols_param = request.args.get('symbols', 'BTC/USDT,ETH/USDT,ADA/USDT')
        symbols = [s.strip() for s in symbols_param.split(',')]
        
        overview = mousatrade_advisor.get_market_overview(symbols)
        
        return jsonify(overview)
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²Ø§Ø±: {e}")
        return jsonify({"error": str(e)}), 500

# API Ø³Ù„Ø§Ù…Øª Ø³ÛŒØ³ØªÙ…
@app.route('/api/health', methods=['GET'])
def health_check():
    """Ø¨Ø±Ø±Ø³ÛŒ Ø³Ù„Ø§Ù…Øª Ø³ÛŒØ³ØªÙ…"""
    try:
        broker_status = "not_set"
        if mousatrade_advisor.current_broker:
            broker_status = mousatrade_advisor.current_broker.health_check()
        
        return jsonify({
            "status": "healthy",
            "timestamp": datetime.now().isoformat(),
            "version": "1.0.0",
            "broker": broker_status,
            "analysis_history_count": len(mousatrade_advisor.analysis_history)
        })
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø³Ù„Ø§Ù…Øªâ€ŒØ³Ù†Ø¬ÛŒ: {e}")
        return jsonify({
            "status": "error",
            "error": str(e)
        }), 500

# API ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§
@app.route('/api/history', methods=['GET'])
def get_analysis_history():
    """Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§"""
    try:
        history = []
        for analysis in mousatrade_advisor.analysis_history[-10:]:  # Û±Û° Ù…ÙˆØ±Ø¯ Ø§Ø®ÛŒØ±
            history.append({
                "symbol": analysis.symbol,
                "position_type": analysis.position_type,
                "confidence": analysis.confidence,
                "timestamp": analysis.timestamp.isoformat()
            })
        
        return jsonify({"history": history})
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ®Ú†Ù‡: {e}")
        return jsonify({"error": str(e)}), 500

# ØµÙØ­Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§Ù‡Ø§
@app.errorhandler(404)
def not_found(error):
    return jsonify({"error": "ØµÙØ­Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯"}), 404

@app.errorhandler(500)
def internal_error(error):
    return jsonify({"error": "Ø®Ø·Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ø³Ø±ÙˆØ±"}), 500

# Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÙˆØ±
if __name__ == '__main__':
    logger.info("ğŸš€ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÙˆØ± MousaTrade...")
    app.run(host='0.0.0.0', port=5000, debug=True)
