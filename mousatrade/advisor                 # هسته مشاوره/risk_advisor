
"""
Ù…Ø´Ø§ÙˆØ± Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú© MousaTrade
"""

import numpy as np
from typing import Dict, List, Tuple, Optional
from datetime import datetime, timedelta
from enum import Enum
import logging
from dataclasses import dataclass

logger = logging.getLogger(__name__)

class RiskAdvisorLevel(Enum):
    VERY_CONSERVATIVE = "VERY_CONSERVATIVE"  # Ø¨Ø³ÛŒØ§Ø± Ù…Ø­Ø§ÙØ¸Ù‡â€ŒÚ©Ø§Ø±
    CONSERVATIVE = "CONSERVATIVE"            # Ù…Ø­Ø§ÙØ¸Ù‡â€ŒÚ©Ø§Ø±
    MODERATE = "MODERATE"                    # Ù…ØªØ¹Ø§Ø¯Ù„
    AGGRESSIVE = "AGGRESSIVE"                # ØªÙ‡Ø§Ø¬Ù…ÛŒ
    VERY_AGGRESSIVE = "VERY_AGGRESSIVE"     # Ø¨Ø³ÛŒØ§Ø± ØªÙ‡Ø§Ø¬Ù…ÛŒ

class MarketCondition(Enum):
    NORMAL = "NORMAL"                        # Ø´Ø±Ø§ÛŒØ· Ø¹Ø§Ø¯ÛŒ
    VOLATILE = "VOLATILE"                    # Ù¾Ø±Ù†ÙˆØ³Ø§Ù†
    TRENDING = "TRENDING"                    # Ø±ÙˆÙ†Ø¯ Ù‚ÙˆÛŒ
    SIDEWAYS = "SIDEWAYS"                   # Ø±Ù†Ø¬
    CRASH = "CRASH"                         # Ø³Ù‚ÙˆØ· Ø´Ø¯ÛŒØ¯
    RALLY = "RALLY"                         # Ø±Ø´Ø¯ Ø´Ø¯ÛŒØ¯

@dataclass
class RiskAssessment:
    """Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø±ÛŒØ³Ú©"""
    symbol: str
    risk_score: float  # 0-100
    risk_level: RiskAdvisorLevel
    market_condition: MarketCondition
    volatility_risk: float
    liquidity_risk: float
    concentration_risk: float
    leverage_risk: float
    recommendations: List[str]
    max_position_size: float
    suggested_leverage: float
    stop_loss_adjustment: float

@dataclass
class PortfolioRisk:
    """Ø±ÛŒØ³Ú© Ù¾Ø±ØªÙÙˆÛŒ"""
    total_risk_score: float
    diversification_score: float
    correlation_risk: float
    sector_exposure: Dict[str, float]
    risk_concentration: List[Tuple[str, float]]
    suggested_allocations: Dict[str, float]

class RiskAdvisor:
    """Ù…Ø´Ø§ÙˆØ± Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú©"""
    
    def __init__(self):
        self.risk_profiles = {
            RiskAdvisorLevel.VERY_CONSERVATIVE: {
                "max_position_size": 0.02,    # 2%
                "max_leverage": 1,
                "stop_loss_multiplier": 1.5,
                "target_risk_reward": 3.0
            },
            RiskAdvisorLevel.CONSERVATIVE: {
                "max_position_size": 0.05,    # 5%
                "max_leverage": 2,
                "stop_loss_multiplier": 1.2,
                "target_risk_reward": 2.5
            },
            RiskAdvisorLevel.MODERATE: {
                "max_position_size": 0.08,    # 8%
                "max_leverage": 3,
                "stop_loss_multiplier": 1.0,
                "target_risk_reward": 2.0
            },
            RiskAdvisorLevel.AGGRESSIVE: {
                "max_position_size": 0.12,    # 12%
                "max_leverage": 5,
                "stop_loss_multiplier": 0.8,
                "target_risk_reward": 1.5
            },
            RiskAdvisorLevel.VERY_AGGRESSIVE: {
                "max_position_size": 0.15,    # 15%
                "max_leverage": 10,
                "stop_loss_multiplier": 0.6,
                "target_risk_reward": 1.2
            }
        }
    
    def assess_symbol_risk(self, symbol: str, 
                          market_data: Dict,
                          technical_analysis: Dict,
                          fundamental_analysis: Dict,
                          user_risk_profile: RiskAdvisorLevel = RiskAdvisorLevel.MODERATE) -> RiskAssessment:
        """Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø±ÛŒØ³Ú© Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ù†Ù…Ø§Ø¯"""
        try:
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ù†ÙˆØ³Ø§Ù†
            volatility_risk = self._calculate_volatility_risk(market_data, technical_analysis)
            
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ù†Ù‚Ø¯Ø´ÙˆÙ†Ø¯Ú¯ÛŒ
            liquidity_risk = self._calculate_liquidity_risk(market_data, fundamental_analysis)
            
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© ØªÙ…Ø±Ú©Ø²
            concentration_risk = self._calculate_concentration_risk(symbol, fundamental_analysis)
            
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ø§Ù‡Ø±Ù…
            leverage_risk = self._calculate_leverage_risk(technical_analysis)
            
            # ØªØ´Ø®ÛŒØµ Ø´Ø±Ø§ÛŒØ· Ø¨Ø§Ø²Ø§Ø±
            market_condition = self._detect_market_condition(technical_analysis, volatility_risk)
            
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ø±ÛŒØ³Ú© Ú©Ù„ÛŒ
            risk_score = self._calculate_overall_risk_score(
                volatility_risk, liquidity_risk, concentration_risk, leverage_risk
            )
            
            # ØªØ¹ÛŒÛŒÙ† Ø³Ø·Ø­ Ø±ÛŒØ³Ú©
            risk_level = self._determine_risk_level(risk_score)
            
            # ØªÙˆÙ„ÛŒØ¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª
            recommendations = self._generate_risk_recommendations(
                risk_score, risk_level, market_condition,
                volatility_risk, liquidity_risk, concentration_risk, leverage_risk
            )
            
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§ÛŒØ² Ù¾ÙˆØ²ÛŒØ´Ù† Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ
            max_position_size = self._calculate_max_position_size(
                risk_level, user_risk_profile, volatility_risk
            )
            
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù‡Ø±Ù… Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ
            suggested_leverage = self._calculate_suggested_leverage(
                risk_level, user_risk_profile, leverage_risk
            )
            
            # ØªÙ†Ø¸ÛŒÙ… Ø­Ø¯ Ø¶Ø±Ø±
            stop_loss_adjustment = self._calculate_stop_loss_adjustment(
                risk_level, volatility_risk
            )
            
            return RiskAssessment(
                symbol=symbol,
                risk_score=risk_score,
                risk_level=risk_level,
                market_condition=market_condition,
                volatility_risk=volatility_risk,
                liquidity_risk=liquidity_risk,
                concentration_risk=concentration_risk,
                leverage_risk=leverage_risk,
                recommendations=recommendations,
                max_position_size=max_position_size,
                suggested_leverage=suggested_leverage,
                stop_loss_adjustment=stop_loss_adjustment
            )
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø±ÛŒØ³Ú© {symbol}: {e}")
            return self._get_default_risk_assessment(symbol)
    
    def assess_portfolio_risk(self, portfolio: Dict, 
                            market_data: Dict) -> PortfolioRisk:
        """Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø±ÛŒØ³Ú© Ù¾Ø±ØªÙÙˆÛŒ"""
        try:
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© ØªÙ†ÙˆØ¹
            diversification_score = self._calculate_diversification_score(portfolio)
            
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ù‡Ù…Ø¨Ø³ØªÚ¯ÛŒ
            correlation_risk = self._calculate_correlation_risk(portfolio, market_data)
            
            # ØªØ­Ù„ÛŒÙ„ Ù…ÙˆØ§Ø¬Ù‡Ù‡ Ø³Ú©ØªÙˆØ±ÛŒ
            sector_exposure = self._analyze_sector_exposure(portfolio)
            
            # Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ ØªÙ…Ø±Ú©Ø² Ø±ÛŒØ³Ú©
            risk_concentration = self._identify_risk_concentration(portfolio)
            
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ø±ÛŒØ³Ú© Ú©Ù„ÛŒ Ù¾Ø±ØªÙÙˆÛŒ
            total_risk_score = self._calculate_portfolio_risk_score(
                diversification_score, correlation_risk, risk_concentration
            )
            
            # Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
            suggested_allocations = self._suggest_portfolio_allocations(
                portfolio, total_risk_score, diversification_score
            )
            
            return PortfolioRisk(
                total_risk_score=total_risk_score,
                diversification_score=diversification_score,
                correlation_risk=correlation_risk,
                sector_exposure=sector_exposure,
                risk_concentration=risk_concentration,
                suggested_allocations=suggested_allocations
            )
            
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø±ÛŒØ³Ú© Ù¾Ø±ØªÙÙˆÛŒ: {e}")
            return self._get_default_portfolio_risk()
    
    def _calculate_volatility_risk(self, market_data: Dict, 
                                 technical_analysis: Dict) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ù†ÙˆØ³Ø§Ù†"""
        try:
            volatility = technical_analysis.get('volatility', {})
            daily_volatility = volatility.get('daily_volatility', 0.02)
            historical_volatility = volatility.get('annualized_volatility', 0.3)
            
            # Ù†Ø±Ù…Ø§Ù„Ø§ÛŒØ² Ú©Ø±Ø¯Ù† Ù†ÙˆØ³Ø§Ù† (0-1)
            vol_risk = min(daily_volatility * 10, 1.0)
            
            # ØªØ¹Ø¯ÛŒÙ„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±Ú˜ÛŒÙ… Ù†ÙˆØ³Ø§Ù†
            volatility_regime = volatility.get('volatility_regime', 'Ù¾Ø§ÛŒÛŒÙ†')
            if volatility_regime == 'Ø¨Ø§Ù„Ø§':
                vol_risk *= 1.5
            elif volatility_regime == 'Ù¾Ø§ÛŒÛŒÙ†':
                vol_risk *= 0.7
            
            return min(vol_risk, 1.0)
            
        except Exception as e:
            logger.warning(f"Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ù†ÙˆØ³Ø§Ù†: {e}")
            return 0.5
    
    def _calculate_liquidity_risk(self, market_data: Dict,
                                fundamental_analysis: Dict) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ù†Ù‚Ø¯Ø´ÙˆÙ†Ø¯Ú¯ÛŒ"""
        try:
            volume_24h = fundamental_analysis.get('metrics', {}).get('volume_24h', 0)
            market_cap = fundamental_analysis.get('metrics', {}).get('market_cap', 0)
            
            if market_cap <= 0:
                return 0.8  # Ø±ÛŒØ³Ú© Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ú©ÙˆÚ†Ú©
            
            # Ù†Ø³Ø¨Øª Ø­Ø¬Ù… Ø¨Ù‡ Ù…Ø§Ø±Ú©Øªâ€ŒÚ©Ù¾
            volume_to_mcap = volume_24h / market_cap if market_cap > 0 else 0
            
            if volume_to_mcap > 0.1:
                liquidity_risk = 0.1  # Ù†Ù‚Ø¯Ø´ÙˆÙ†Ø¯Ú¯ÛŒ Ø¹Ø§Ù„ÛŒ
            elif volume_to_mcap > 0.05:
                liquidity_risk = 0.3  # Ù†Ù‚Ø¯Ø´ÙˆÙ†Ø¯Ú¯ÛŒ Ø®ÙˆØ¨
            elif volume_to_mcap > 0.01:
                liquidity_risk = 0.6  # Ù†Ù‚Ø¯Ø´ÙˆÙ†Ø¯Ú¯ÛŒ Ù…ØªÙˆØ³Ø·
            else:
                liquidity_risk = 0.9  # Ù†Ù‚Ø¯Ø´ÙˆÙ†Ø¯Ú¯ÛŒ Ø¶Ø¹ÛŒÙ
            
            return liquidity_risk
            
        except Exception as e:
            logger.warning(f"Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ù†Ù‚Ø¯Ø´ÙˆÙ†Ø¯Ú¯ÛŒ: {e}")
            return 0.5
    
    def _calculate_concentration_risk(self, symbol: str,
                                   fundamental_analysis: Dict) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© ØªÙ…Ø±Ú©Ø²"""
        try:
            market_cap_rank = fundamental_analysis.get('metrics', {}).get('market_cap_rank', 999)
            
            if market_cap_rank <= 10:
                return 0.1  # Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø±ØªØ± - Ø±ÛŒØ³Ú© Ú©Ù…
            elif market_cap_rank <= 50:
                return 0.3  # Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ - Ø±ÛŒØ³Ú© Ù…ØªÙˆØ³Ø·
            elif market_cap_rank <= 100:
                return 0.6  # Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ØªÙˆØ³Ø· - Ø±ÛŒØ³Ú© Ù†Ø³Ø¨ØªØ§Ù‹ Ø¨Ø§Ù„Ø§
            else:
                return 0.9  # Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÛŒ Ú©ÙˆÚ†Ú© - Ø±ÛŒØ³Ú© Ø¨Ø§Ù„Ø§
                
        except Exception as e:
            logger.warning(f"Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© ØªÙ…Ø±Ú©Ø²: {e}")
            return 0.5
    
    def _calculate_leverage_risk(self, technical_analysis: Dict) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ø§Ù‡Ø±Ù…"""
        try:
            trend = technical_analysis.get('trend', {})
            trend_strength = trend.get('strength', 0.5)
            
            # Ø¯Ø± Ø±ÙˆÙ†Ø¯Ù‡Ø§ÛŒ Ù‚ÙˆÛŒØŒ Ø±ÛŒØ³Ú© Ø§Ù‡Ø±Ù… Ú©Ù…ØªØ± Ø§Ø³Øª
            if trend_strength > 0.7:
                leverage_risk = 0.3
            elif trend_strength > 0.5:
                leverage_risk = 0.5
            elif trend_strength > 0.3:
                leverage_risk = 0.7
            else:
                leverage_risk = 0.9  # Ø¯Ø± Ø¨Ø§Ø²Ø§Ø± Ø¨Ø¯ÙˆÙ† Ø±ÙˆÙ†Ø¯ØŒ Ø§Ù‡Ø±Ù… Ø®Ø·Ø±Ù†Ø§Ú© Ø§Ø³Øª
            
            return leverage_risk
            
        except Exception as e:
            logger.warning(f"Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ø§Ù‡Ø±Ù…: {e}")
            return 0.5
    
    def _detect_market_condition(self, technical_analysis: Dict,
                               volatility_risk: float) -> MarketCondition:
        """ØªØ´Ø®ÛŒØµ Ø´Ø±Ø§ÛŒØ· Ø¨Ø§Ø²Ø§Ø±"""
        try:
            trend = technical_analysis.get('trend', {})
            trend_direction = trend.get('direction', 'Ø¨Ø¯ÙˆÙ† Ø±ÙˆÙ†Ø¯ Ù…Ø´Ø®Øµ')
            trend_strength = trend.get('strength', 0.5)
            
            if volatility_risk > 0.8:
                return MarketCondition.VOLATILE
            elif trend_strength > 0.7:
                if trend_direction == "ØµØ¹ÙˆØ¯ÛŒ":
                    return MarketCondition.RALLY
                else:
                    return MarketCondition.CRASH
            elif trend_strength < 0.3:
                return MarketCondition.SIDEWAYS
            elif trend_strength > 0.5:
                return MarketCondition.TRENDING
            else:
                return MarketCondition.NORMAL
                
        except Exception as e:
            logger.warning(f"Ø®Ø·Ø§ Ø¯Ø± ØªØ´Ø®ÛŒØµ Ø´Ø±Ø§ÛŒØ· Ø¨Ø§Ø²Ø§Ø±: {e}")
            return MarketCondition.NORMAL
    
    def _calculate_overall_risk_score(self, volatility_risk: float,
                                   liquidity_risk: float,
                                   concentration_risk: float,
                                   leverage_risk: float) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ø±ÛŒØ³Ú© Ú©Ù„ÛŒ"""
        # ÙˆØ²Ù†â€ŒØ¯Ù‡ÛŒ Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø±ÛŒØ³Ú©
        weights = {
            'volatility': 0.3,
            'liquidity': 0.25,
            'concentration': 0.25,
            'leverage': 0.2
        }
        
        overall_risk = (
            volatility_risk * weights['volatility'] +
            liquidity_risk * weights['liquidity'] +
            concentration_risk * weights['concentration'] +
            leverage_risk * weights['leverage']
        )
        
        return min(overall_risk * 100, 100)
    
    def _determine_risk_level(self, risk_score: float) -> RiskAdvisorLevel:
        """ØªØ¹ÛŒÛŒÙ† Ø³Ø·Ø­ Ø±ÛŒØ³Ú©"""
        if risk_score < 20:
            return RiskAdvisorLevel.VERY_CONSERVATIVE
        elif risk_score < 40:
            return RiskAdvisorLevel.CONSERVATIVE
        elif risk_score < 60:
            return RiskAdvisorLevel.MODERATE
        elif risk_score < 80:
            return RiskAdvisorLevel.AGGRESSIVE
        else:
            return RiskAdvisorLevel.VERY_AGGRESSIVE
    
    def _generate_risk_recommendations(self, risk_score: float,
                                    risk_level: RiskAdvisorLevel,
                                    market_condition: MarketCondition,
                                    volatility_risk: float,
                                    liquidity_risk: float,
                                    concentration_risk: float,
                                    leverage_risk: float) -> List[str]:
        """ØªÙˆÙ„ÛŒØ¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú©"""
        recommendations = []
        
        # Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø·Ø­ Ø±ÛŒØ³Ú©
        if risk_level in [RiskAdvisorLevel.AGGRESSIVE, RiskAdvisorLevel.VERY_AGGRESSIVE]:
            recommendations.append("âš ï¸ Ø³Ø·Ø­ Ø±ÛŒØ³Ú© Ø¨Ø§Ù„Ø§ - Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² Ù¾ÙˆØ²ÛŒØ´Ù† Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯")
        
        # Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ø±Ø§ÛŒØ· Ø¨Ø§Ø²Ø§Ø±
        if market_condition == MarketCondition.VOLATILE:
            recommendations.append("ğŸ“ˆ Ø¨Ø§Ø²Ø§Ø± Ù¾Ø±Ù†ÙˆØ³Ø§Ù† - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø³ØªØ§Ù¾â€ŒÙ„Ø§Ø³ Ú¯Ø³ØªØ±Ø¯Ù‡")
        elif market_condition in [MarketCondition.CRASH, MarketCondition.RALLY]:
            recommendations.append("ğŸ¯ Ø¨Ø§Ø²Ø§Ø± Ø¯Ø± Ø­Ø§Ù„Øª Ø§ÙØ±Ø§Ø· - Ø§Ø­ØªÛŒØ§Ø· Ø¯Ø± Ù…Ø¹Ø§Ù…Ù„Ø§Øª")
        
        # Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÛŒØ³Ú© Ù†Ù‚Ø¯Ø´ÙˆÙ†Ø¯Ú¯ÛŒ
        if liquidity_risk > 0.7:
            recommendations.append("ğŸ’§ Ù†Ù‚Ø¯Ø´ÙˆÙ†Ø¯Ú¯ÛŒ Ù¾Ø§ÛŒÛŒÙ† - Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø§ Ø­Ø¬Ù… Ú©Ù…")
        
        # Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÛŒØ³Ú© ØªÙ…Ø±Ú©Ø²
        if concentration_risk > 0.7:
            recommendations.append("ğŸª ØªÙ…Ø±Ú©Ø² Ø¨Ø§Ù„Ø§ - Ù…ØªÙ†ÙˆØ¹â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø±ØªÙÙˆÛŒ")
        
        # Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÛŒØ³Ú© Ø§Ù‡Ø±Ù…
        if leverage_risk > 0.7:
            recommendations.append("âš–ï¸ Ø´Ø±Ø§ÛŒØ· Ù†Ø§Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ø§Ù‡Ø±Ù… - Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø¯ÙˆÙ† Ø§Ù‡Ø±Ù…")
        
        if not recommendations:
            recommendations.append("âœ… Ø´Ø±Ø§ÛŒØ· Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ - Ø±Ø¹Ø§ÛŒØª Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú©")
        
        return recommendations
    
    def _calculate_max_position_size(self, risk_level: RiskAdvisorLevel,
                                   user_risk_profile: RiskAdvisorLevel,
                                   volatility_risk: float) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¯Ø§Ú©Ø«Ø± Ø³Ø§ÛŒØ² Ù¾ÙˆØ²ÛŒØ´Ù†"""
        base_size = self.risk_profiles[user_risk_profile]["max_position_size"]
        
        # ØªØ¹Ø¯ÛŒÙ„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÛŒØ³Ú© Ù†Ù…Ø§Ø¯
        if risk_level in [RiskAdvisorLevel.AGGRESSIVE, RiskAdvisorLevel.VERY_AGGRESSIVE]:
            base_size *= 0.5  # Ú©Ø§Ù‡Ø´ 50% Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§Ø¯Ù‡Ø§ÛŒ Ù¾Ø±Ø±ÛŒØ³Ú©
        elif risk_level in [RiskAdvisorLevel.VERY_CONSERVATIVE, RiskAdvisorLevel.CONSERVATIVE]:
            base_size *= 1.2  # Ø§ÙØ²Ø§ÛŒØ´ 20% Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§Ø¯Ù‡Ø§ÛŒ Ú©Ù…â€ŒØ±ÛŒØ³Ú©
        
        # ØªØ¹Ø¯ÛŒÙ„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ³Ø§Ù†
        if volatility_risk > 0.7:
            base_size *= 0.7  # Ú©Ø§Ù‡Ø´ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ³Ø§Ù† Ø¨Ø§Ù„Ø§
        
        return min(base_size, 0.2)  # Ø­Ø¯Ø§Ú©Ø«Ø± 20%
    
    def _calculate_suggested_leverage(self, risk_level: RiskAdvisorLevel,
                                    user_risk_profile: RiskAdvisorLevel,
                                    leverage_risk: float) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù‡Ø±Ù… Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ"""
        base_leverage = self.risk_profiles[user_risk_profile]["max_leverage"]
        
        # ØªØ¹Ø¯ÛŒÙ„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÛŒØ³Ú© Ù†Ù…Ø§Ø¯
        if risk_level in [RiskAdvisorLevel.AGGRESSIVE, RiskAdvisorLevel.VERY_AGGRESSIVE]:
            base_leverage *= 0.5
        
        # ØªØ¹Ø¯ÛŒÙ„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÛŒØ³Ú© Ø§Ù‡Ø±Ù…
        if leverage_risk > 0.7:
            base_leverage = 1  # Ø¨Ø¯ÙˆÙ† Ø§Ù‡Ø±Ù…
        
        return max(base_leverage, 1)  # Ø­Ø¯Ø§Ù‚Ù„ 1x
    
    def _calculate_stop_loss_adjustment(self, risk_level: RiskAdvisorLevel,
                                      volatility_risk: float) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­Ø¯ Ø¶Ø±Ø±"""
        base_multiplier = self.risk_profiles[risk_level]["stop_loss_multiplier"]
        
        # ØªØ¹Ø¯ÛŒÙ„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ³Ø§Ù†
        if volatility_risk > 0.7:
            base_multiplier *= 1.3  # Ø§Ø³ØªØ§Ù¾ Ú¯Ø³ØªØ±Ø¯Ù‡â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ³Ø§Ù† Ø¨Ø§Ù„Ø§
        elif volatility_risk < 0.3:
            base_multiplier *= 0.8  # Ø§Ø³ØªØ§Ù¾ tighter Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ³Ø§Ù† Ù¾Ø§ÛŒÛŒÙ†
        
        return base_multiplier
    
    # Ù…ØªØ¯Ù‡Ø§ÛŒ Ù¾Ø±ØªÙÙˆÛŒ (Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§Ø¯Ù‡â€ŒØ´Ø¯Ù‡)
    def _calculate_diversification_score(self, portfolio: Dict) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² ØªÙ†ÙˆØ¹"""
        return 0.7  # Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ
    
    def _calculate_correlation_risk(self, portfolio: Dict, market_data: Dict) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ù‡Ù…Ø¨Ø³ØªÚ¯ÛŒ"""
        return 0.3  # Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ
    
    def _analyze_sector_exposure(self, portfolio: Dict) -> Dict[str, float]:
        """ØªØ­Ù„ÛŒÙ„ Ù…ÙˆØ§Ø¬Ù‡Ù‡ Ø³Ú©ØªÙˆØ±ÛŒ"""
        return {"DeFi": 0.4, "Layer1": 0.3, "NFT": 0.2, "Other": 0.1}
    
    def _identify_risk_concentration(self, portfolio: Dict) -> List[Tuple[str, float]]:
        """Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ ØªÙ…Ø±Ú©Ø² Ø±ÛŒØ³Ú©"""
        return [("BTC", 0.3), ("ETH", 0.25), ("ADA", 0.15)]
    
    def _calculate_portfolio_risk_score(self, diversification: float,
                                      correlation: float,
                                      concentration: List) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ø±ÛŒØ³Ú© Ù¾Ø±ØªÙÙˆÛŒ"""
        return 45.0  # Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ
    
    def _suggest_portfolio_allocations(self, portfolio: Dict,
                                     risk_score: float,
                                     diversification: float) -> Dict[str, float]:
        """Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ ØªØ®ØµÛŒØµâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±ØªÙÙˆÛŒ"""
        return {"BTC": 0.4, "ETH": 0.3, "DOT": 0.1, "LINK": 0.1, "ADA": 0.1}
    
    def _get_default_risk_assessment(self, symbol: str) -> RiskAssessment:
        """Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø±ÛŒØ³Ú© Ù¾ÛŒØ´â€ŒÙØ±Ø¶"""
        return RiskAssessment(
            symbol=symbol,
            risk_score=50.0,
            risk_level=RiskAdvisorLevel.MODERATE,
            market_condition=MarketCondition.NORMAL,
            volatility_risk=0.5,
            liquidity_risk=0.5,
            concentration_risk=0.5,
            leverage_risk=0.5,
            recommendations=["ØªØ­Ù„ÛŒÙ„ Ø±ÛŒØ³Ú© Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª"],
            max_position_size=0.05,
            suggested_leverage=2.0,
            stop_loss_adjustment=1.0
        )
    
    def _get_default_portfolio_risk(self) -> PortfolioRisk:
        """Ø±ÛŒØ³Ú© Ù¾Ø±ØªÙÙˆÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶"""
        return PortfolioRisk(
            total_risk_score=50.0,
            diversification_score=0.5,
            correlation_risk=0.5,
            sector_exposure={},
            risk_concentration=[],
            suggested_allocations={}
        )
