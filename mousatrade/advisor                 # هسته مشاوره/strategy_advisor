
"""
Ù…Ø´Ø§ÙˆØ± Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ MousaTrade
Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ø±Ø§ÛŒØ· Ø¨Ø§Ø²Ø§Ø±
"""

from typing import Dict, List, Optional
from enum import Enum
import logging
from dataclasses import dataclass

logger = logging.getLogger(__name__)

class StrategyType(Enum):
    TREND_FOLLOWING = "TREND_FOLLOWING"
    MEAN_REVERSION = "MEAN_REVERSION"
    BREAKOUT = "BREAKOUT"
    SCALPING = "SCALPING"
    SWING_TRADING = "SWING_TRADING"

class MarketRegime(Enum):
    TRENDING = "TRENDING"
    RANGING = "RANGING"
    VOLATILE = "VOLATILE"
    LOW_VOLATILITY = "LOW_VOLATILITY"

@dataclass
class StrategyAdvice:
    symbol: str
    strategy_type: StrategyType
    market_regime: MarketRegime
    confidence: float
    parameters: Dict
    description: str
    risk_level: str
    timeframe: str

class StrategyAdvisor:
    """Ù…Ø´Ø§ÙˆØ± Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ"""
    
    def __init__(self):
        self.strategy_configs = {
            StrategyType.TREND_FOLLOWING: {
                "description": "Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¯Ø± Ø¬Ù‡Øª Ø±ÙˆÙ†Ø¯ Ø§ØµÙ„ÛŒ",
                "suitable_for": ["TRENDING"],
                "timeframes": ["4h", "1d"],
                "risk": "MEDIUM"
            },
            StrategyType.MEAN_REVERSION: {
                "description": "Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†",
                "suitable_for": ["RANGING"],
                "timeframes": ["1h", "4h"],
                "risk": "HIGH"
            },
            StrategyType.BREAKOUT: {
                "description": "Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¯Ø± Ø²Ù…Ø§Ù† Ø´Ú©Ø³Øª Ø³Ø·ÙˆØ­",
                "suitable_for": ["RANGING", "LOW_VOLATILITY"],
                "timeframes": ["1h", "4h"],
                "risk": "HIGH"
            },
            StrategyType.SCALPING: {
                "description": "Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª Ø¨Ø§ Ø³ÙˆØ¯Ù‡Ø§ÛŒ Ú©ÙˆÚ†Ú©",
                "suitable_for": ["VOLATILE"],
                "timeframes": ["1m", "5m"],
                "risk": "VERY_HIGH"
            },
            StrategyType.SWING_TRADING: {
                "description": "Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ú†Ù†Ø¯Ø±ÙˆØ²Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ³Ø§Ù†Ø§Øª",
                "suitable_for": ["TRENDING", "RANGING"],
                "timeframes": ["4h", "1d"],
                "risk": "MEDIUM"
            }
        }
    
    def get_strategy_recommendation(self, symbol: str, technical_analysis: Dict,
                                  position_advice: Dict) -> StrategyAdvice:
        """Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ"""
        try:
            # ØªØ´Ø®ÛŒØµ Ø±Ú˜ÛŒÙ… Ø¨Ø§Ø²Ø§Ø±
            market_regime = self._detect_market_regime(technical_analysis)
            
            # Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ù…Ù†Ø§Ø³Ø¨
            strategy_type = self._select_strategy(market_regime, technical_analysis)
            
            # ØªÙ†Ø¸ÛŒÙ… Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ
            strategy_params = self._get_strategy_parameters(strategy_type, technical_analysis)
            
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†
            confidence = self._calculate_strategy_confidence(strategy_type, market_regime, technical_analysis)
            
            # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ
            advice = StrategyAdvice(
                symbol=symbol,
                strategy_type=strategy_type,
                market_regime=market_regime,
                confidence=confidence,
                parameters=strategy_params,
                description=self.strategy_configs[strategy_type]["description"],
                risk_level=self.strategy_configs[strategy_type]["risk"],
                timeframe=self._get_recommended_timeframe(strategy_type)
            )
            
            logger.info(f"ğŸ¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø¨Ø±Ø§ÛŒ {symbol}: {strategy_type.value}")
            
            return advice
            
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ: {e}")
            return self._get_default_strategy(symbol)
    
    def _detect_market_regime(self, technical_analysis: Dict) -> MarketRegime:
        """ØªØ´Ø®ÛŒØµ Ø±Ú˜ÛŒÙ… Ø¨Ø§Ø²Ø§Ø±"""
        try:
            trend = technical_analysis.get('trend', {})
            volatility = technical_analysis.get('volatility', {})
            
            trend_strength = trend.get('strength', 0.5)
            daily_volatility = volatility.get('daily_volatility', 0.02)
            volatility_regime = volatility.get('volatility_regime', 'Ù¾Ø§ÛŒÛŒÙ†')
            
            # ØªØ´Ø®ÛŒØµ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù‚Ø¯Ø±Øª Ø±ÙˆÙ†Ø¯ Ùˆ Ù†ÙˆØ³Ø§Ù†
            if trend_strength > 0.7:
                return MarketRegime.TRENDING
            elif volatility_regime == 'Ø¨Ø§Ù„Ø§' or daily_volatility > 0.04:
                return MarketRegime.VOLATILE
            elif trend_strength < 0.3:
                return MarketRegime.RANGING
            else:
                return MarketRegime.LOW_VOLATILITY
                
        except Exception as e:
            logger.warning(f"Ø®Ø·Ø§ Ø¯Ø± ØªØ´Ø®ÛŒØµ Ø±Ú˜ÛŒÙ… Ø¨Ø§Ø²Ø§Ø±: {e}")
            return MarketRegime.RANGING
    
    def _select_strategy(self, market_regime: MarketRegime, 
                        technical_analysis: Dict) -> StrategyType:
        """Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ù…Ù†Ø§Ø³Ø¨"""
        
        # Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±Ú˜ÛŒÙ…
        regime_strategies = {
            MarketRegime.TRENDING: [StrategyType.TREND_FOLLOWING, StrategyType.SWING_TRADING],
            MarketRegime.RANGING: [StrategyType.MEAN_REVERSION, StrategyType.BREAKOUT],
            MarketRegime.VOLATILE: [StrategyType.SCALPING, StrategyType.BREAKOUT],
            MarketRegime.LOW_VOLATILITY: [StrategyType.BREAKOUT, StrategyType.SWING_TRADING]
        }
        
        # Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ø±Ø§ÛŒØ· ØªÚ©Ù†ÛŒÚ©Ø§Ù„
        suitable_strategies = regime_strategies.get(market_regime, [StrategyType.SWING_TRADING])
        
        # Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ­Ù„ÛŒÙ„ ØªÚ©Ù†ÛŒÚ©Ø§Ù„
        if market_regime == MarketRegime.TRENDING:
            return StrategyType.TREND_FOLLOWING
        elif market_regime == MarketRegime.RANGING:
            # Ø§Ú¯Ø± Ø¨Ø§Ø²Ø§Ø± Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ù…Ø´Ø®ØµÛŒ Ù†ÙˆØ³Ø§Ù† Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            support_resistance = technical_analysis.get('support_resistance', {})
            if (support_resistance.get('nearest_support') and 
                support_resistance.get('nearest_resistance')):
                return StrategyType.MEAN_REVERSION
            else:
                return StrategyType.BREAKOUT
        elif market_regime == MarketRegime.VOLATILE:
            return StrategyType.SCALPING
        else:
            return StrategyType.BREAKOUT
    
    def _get_strategy_parameters(self, strategy_type: StrategyType,
                               technical_analysis: Dict) -> Dict:
        """ØªÙ†Ø¸ÛŒÙ… Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ"""
        
        base_params = {
            "trailing_stop": False,
            "pyramid": False,
            "max_positions": 1
        }
        
        if strategy_type == StrategyType.TREND_FOLLOWING:
            params = {
                **base_params,
                "entry_on_pullback": True,
                "use_moving_averages": True,
                "trend_confirmation_period": 20,
                "stop_loss_type": "atr",  # based on ATR
                "take_profit_ratio": 2.0  # 2:1 risk reward
            }
            
        elif strategy_type == StrategyType.MEAN_REVERSION:
            params = {
                **base_params,
                "oversold_threshold": 30,  # RSI
                "overbought_threshold": 70,  # RSI
                "bollinger_bands_period": 20,
                "mean_reversion_period": 14,
                "stop_loss_type": "percentage",
                "stop_loss_percentage": 0.03  # 3%
            }
            
        elif strategy_type == StrategyType.BREAKOUT:
            params = {
                **base_params,
                "breakout_confirmation": True,
                "consolidation_period": 10,
                "volume_confirmation": True,
                "false_breakout_protection": True,
                "breakout_retest_entry": True
            }
            
        elif strategy_type == StrategyType.SCALPING:
            params = {
                **base_params,
                "quick_exit": True,
                "small_timeframe": "1m",
                "profit_target": 0.005,  # 0.5%
                "max_holding_time": 300,  # 5 minutes
                "use_tight_stops": True
            }
            
        else:  # SWING_TRADING
            params = {
                **base_params,
                "swing_identification": True,
                "fibonacci_retracement": True,
                "multiple_timeframe_analysis": True,
                "position_holding_period": "2-5 days",
                "risk_reward_minimum": 1.5
            }
        
        return params
    
    def _calculate_strategy_confidence(self, strategy_type: StrategyType,
                                    market_regime: MarketRegime,
                                    technical_analysis: Dict) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ"""
        
        base_confidence = 0.7
        
        # ØªØ¹Ø¯ÛŒÙ„ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ·Ø§Ø¨Ù‚ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø¨Ø§ Ø±Ú˜ÛŒÙ… Ø¨Ø§Ø²Ø§Ø±
        regime_match = {
            StrategyType.TREND_FOLLOWING: 1.0 if market_regime == MarketRegime.TRENDING else 0.6,
            StrategyType.MEAN_REVERSION: 1.0 if market_regime == MarketRegime.RANGING else 0.5,
            StrategyType.BREAKOUT: 0.8 if market_regime in [MarketRegime.RANGING, MarketRegime.LOW_VOLATILITY] else 0.6,
            StrategyType.SCALPING: 1.0 if market_regime == MarketRegime.VOLATILE else 0.4,
            StrategyType.SWING_TRADING: 0.8  # Ù‡Ù…Ù‡â€ŒÚ©Ø§Ø±Ù‡
        }
        
        regime_factor = regime_match.get(strategy_type, 0.7)
        
        # ØªØ¹Ø¯ÛŒÙ„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù‚Ø¯Ø±Øª Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù†ÛŒÚ©Ø§Ù„
        technical_confidence = technical_analysis.get('summary', {}).get('confidence', 0.5)
        
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
        final_confidence = base_confidence * regime_factor * technical_confidence
        
        return round(min(final_confidence, 0.95), 2)
    
    def _get_recommended_timeframe(self, strategy_type: StrategyType) -> str:
        """Ø¯Ø±ÛŒØ§ÙØª ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ… Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ"""
        timeframe_map = {
            StrategyType.TREND_FOLLOWING: "4h",
            StrategyType.MEAN_REVERSION: "1h",
            StrategyType.BREAKOUT: "1h",
            StrategyType.SCALPING: "5m",
            StrategyType.SWING_TRADING: "4h"
        }
        return timeframe_map.get(strategy_type, "1h")
    
    def get_strategy_performance_metrics(self, strategy_type: StrategyType) -> Dict:
        """Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ"""
        # Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)
        performance_data = {
            StrategyType.TREND_FOLLOWING: {
                "win_rate": 0.65,
                "avg_profit": 0.15,
                "avg_loss": -0.08,
                "profit_factor": 1.8,
                "max_drawdown": -0.12
            },
            StrategyType.MEAN_REVERSION: {
                "win_rate": 0.55,
                "avg_profit": 0.08,
                "avg_loss": -0.12,
                "profit_factor": 1.2,
                "max_drawdown": -0.18
            },
            StrategyType.BREAKOUT: {
                "win_rate": 0.45,
                "avg_profit": 0.25,
                "avg_loss": -0.10,
                "profit_factor": 2.0,
                "max_drawdown": -0.15
            },
            StrategyType.SCALPING: {
                "win_rate": 0.75,
                "avg_profit": 0.03,
                "avg_loss": -0.02,
                "profit_factor": 2.5,
                "max_drawdown": -0.08
            },
            StrategyType.SWING_TRADING: {
                "win_rate": 0.60,
                "avg_profit": 0.12,
                "avg_loss": -0.07,
                "profit_factor": 1.6,
                "max_drawdown": -0.10
            }
        }
        
        return performance_data.get(strategy_type, {})
    
    def _get_default_strategy(self, symbol: str) -> StrategyAdvice:
        """Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§"""
        return StrategyAdvice(
            symbol=symbol,
            strategy_type=StrategyType.SWING_TRADING,
            market_regime=MarketRegime.RANGING,
            confidence=0.5,
            parameters={},
            description="Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ù‡Ù…Ù‡â€ŒÚ©Ø§Ø±Ù‡ Ø¨Ø±Ø§ÛŒ Ø´Ø±Ø§ÛŒØ· Ù…Ø®ØªÙ„Ù Ø¨Ø§Ø²Ø§Ø±",
            risk_level="MEDIUM",
            timeframe="4h"
        )
